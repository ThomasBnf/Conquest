generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

enum SOURCE {
    Api
    Discourse
    Discord
    Github
    Linkedin
    Livestorm
    Manual
    Slack
}

enum STATUS {
    ENABLED
    CONNECTED
    SYNCING
    DISCONNECTED
}

enum PLAN {
    BASIC
    PREMIUM
    BUSINESS
    ENTERPRISE
}

enum ROLE {
    STAFF
    ADMIN
}

model api_key {
    id    String @id @default(uuid())
    name  String
    token String @unique

    workspace_id String
    workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())

    @@index([id])
    @@index([workspace_id])
}

model channel {
    id          String  @id @default(uuid())
    external_id String?
    name        String
    slug        String?
    source      SOURCE

    workspace_id String
    workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@unique([external_id, workspace_id])
    @@index([external_id, workspace_id])
    @@index([workspace_id])
}

model event {
    id          String    @id @default(uuid())
    external_id String    @unique
    title       String
    started_at  DateTime
    ended_at    DateTime?
    source      SOURCE

    workspace_id String
    workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@index([id, workspace_id])
    @@index([source, workspace_id])
}

model integration {
    id            String    @id @default(uuid())
    external_id   String?   @unique
    connected_at  DateTime?
    status        STATUS
    details       Json
    trigger_token String
    expires_at    DateTime
    created_by    String

    workspace_id String
    workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@index([id, workspace_id])
    @@index([external_id])
}

model list {
    id           String @id @default(uuid())
    emoji        String
    name         String
    groupFilters Json   @default("{\"filters\":[],\"operator\":\"AND\"}")

    workspace_id String
    workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@index([id, workspace_id])
}

model post {
    id          String @id @default(cuid())
    external_id String
    content     String
    author_id   String

    workspace_id String
    workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())

    @@unique([external_id, workspace_id])
    @@index([external_id, workspace_id])
}

model tag {
    id          String  @id @default(uuid())
    external_id String?
    name        String
    color       String
    source      SOURCE

    workspace_id String
    workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@unique([external_id, workspace_id])
    @@index([id, workspace_id])
}

model user {
    id                    String    @id @default(uuid())
    email                 String    @unique
    hashed_password       String
    first_name            String?
    last_name             String?
    onboarding            DateTime?
    role                  ROLE      @default(ADMIN)
    last_seen             DateTime  @updatedAt
    members_preferences   Json      @default("{\"id\":\"full_name\",\"desc\":true,\"pageSize\":50,\"groupFilters\":{\"filters\":[],\"operator\":\"AND\"},\"columnVisibility\":{},\"columnOrder\":[]}")
    companies_preferences Json      @default("{\"id\":\"name\",\"desc\":true,\"pageSize\":50,\"groupFilters\":{\"filters\":[],\"operator\":\"AND\"},\"columnVisibility\":{},\"columnOrder\":[]}")

    workspace_id String
    workspace    workspace? @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@index([id])
    @@index([email])
}

model webhook {
    id      String @id @default(uuid())
    trigger String
    url     String
    secret  String

    workspace_id String
    workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@index([id, workspace_id])
    @@index([workspace_id])
}

model workflow {
    id          String    @id @default(uuid())
    name        String
    description String?
    nodes       Json[]
    edges       Json[]
    published   Boolean   @default(false)
    last_run_at DateTime?

    workspace_id String
    workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@index([id, workspace_id])
}

model workspace {
    id           String  @id @default(uuid())
    name         String
    slug         String  @unique
    source       String?
    company_size String?
    plan         PLAN    @default(BASIC)

    api_keys     api_key[]
    channels     channel[]
    events       event[]
    integrations integration[]
    lists        list[]
    tags         tag[]
    users        user[]
    webhooks     webhook[]
    workflows    workflow[]

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt
    post       post[]

    @@index([id])
}
